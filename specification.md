# Slack Timeline Retro - ã‚·ã‚¹ãƒ†ãƒ ä»•æ§˜æ›¸ v4

## 1. æ¦‚è¦

Slackã®è‡ªåˆ†è‡ªèº«ã®æŠ•ç¨¿ãƒ­ã‚°ã‚’AIã§è§£æã—ã€é€±æ¬¡ãƒ»æœˆæ¬¡ãƒ»å¹´æ¬¡ã®éšå±¤çš„ãªã‚µãƒãƒªãƒ¼ã‚’ä½œæˆã™ã‚‹ãƒ„ãƒ¼ãƒ«ã€‚User Token OAuthã§ãƒ¦ãƒ¼ã‚¶ãƒ¼èªå¯ã‚’è¡Œã„ã€ã‚µãƒãƒªãƒ¼ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼è‡ªèº«ã®ã‚»ãƒ«ãƒ•DMï¼ˆnotes to selfï¼‰ã«æŠ•ç¨¿ã•ã‚Œã‚‹ã€‚

## 2. ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### 2.1 æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

| ã‚«ãƒ†ã‚´ãƒª | æŠ€è¡“ |
|----------|------|
| ãƒ©ãƒ³ã‚¿ã‚¤ãƒ  | Google Cloud Run |
| ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ | Firestore (Token Storage) |
| è¨€èª | TypeScript |
| ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ | Hono |
| Slack SDK | @slack/web-api |
| AI SDK | Vercel AI SDK v5 |
| ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ | Zod v4 |
| ã‚³ãƒ³ãƒ†ãƒŠ | Docker |

### 2.2 ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å›³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              Slack Workspace                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Any Channel    â”‚                              â”‚  Self-DM (User)     â”‚   â”‚
â”‚  â”‚  /summarize-2025â”‚                              â”‚  â”œâ”€ Start message   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚  â”œâ”€ Week summaries  â”‚   â”‚
â”‚           â”‚                                       â”‚  â”œâ”€ Monthly summary â”‚   â”‚
â”‚           â”‚                                       â”‚  â””â”€ Complete messageâ”‚   â”‚
â”‚           â–¼                                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                                                 â”‚
            â–¼                                                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           Google Cloud Platform             â”‚               â”‚
â”‚                                                             â”‚               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚               â”‚
â”‚  â”‚         Cloud Run (Command Handler)   â”‚                  â”‚               â”‚
â”‚  â”‚  POST /slack/command                  â”‚                  â”‚               â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚                  â”‚               â”‚
â”‚  â”‚  â”‚ 1. Verify Slack signature      â”‚  â”‚                  â”‚               â”‚
â”‚  â”‚  â”‚ 2. Check User Token (Firestore)â”‚â”€â”€â”¼â”€â”€â–ºâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚               â”‚
â”‚  â”‚  â”‚ 3. If no token â†’ OAuth redirectâ”‚  â”‚  â”‚ Firestore   â”‚â”‚               â”‚
â”‚  â”‚  â”‚ 4. Open self-DM channel        â”‚â”€â”€â”¼â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”˜               â”‚
â”‚  â”‚  â”‚ 5. Post start message          â”‚  â”‚  â”‚             â”‚                â”‚
â”‚  â”‚  â”‚ 6. Background: Generate summaryâ”‚â”€â”€â”¼â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚             â”‚  (User Token)
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚             â”‚
â”‚                                            â”‚             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚             â”‚
â”‚  â”‚         OAuth Flow                    â”‚  â”‚             â”‚
â”‚  â”‚  GET /oauth/install                   â”‚  â”‚             â”‚
â”‚  â”‚  GET /oauth/callback                  â”‚â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚ (Store token)
â”‚  â”‚  â”‚ 1. Exchange code for token     â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ 2. Store token in Firestore    â”‚  â”‚  â”‚
â”‚  â”‚  â”‚ 3. Redirect to success page    â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â”‚         Background Processing         â”‚  â”‚  â”‚     AI API              â”‚
â”‚  â”‚  (setImmediate in same process)       â”‚  â”‚  â”‚  (OpenAI / Anthropic)   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â”‚  â”‚ 1. search.messages (User Token)â”‚â—„â”€â”¼â”€â”€â”˜              â”‚
â”‚  â”‚  â”‚ 2. Generate summary via AI     â”‚â—„â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  â”‚  â”‚ 3. Post to self-DM thread      â”‚  â”‚
â”‚  â”‚  â”‚ 4. Post completion message     â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 3. å‡¦ç†ãƒ•ãƒ­ãƒ¼è©³ç´°

### 3.1 Phase 1: ã‚³ãƒãƒ³ãƒ‰å—ä¿¡

```
POST /slack/command
```

#### Step 1: ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ¤œè¨¼
- Slackç½²åæ¤œè¨¼ (`X-Slack-Signature`, `X-Slack-Request-Timestamp`)

#### Step 2: User Tokenç¢ºèª
- Firestoreã‹ã‚‰ `user_tokens/{userId}` ã‚’å–å¾—
- ãƒˆãƒ¼ã‚¯ãƒ³ãŒãªã„å ´åˆ â†’ OAuthèªå¯URLã‚’è¿”å´

#### Step 3: ã‚³ãƒãƒ³ãƒ‰ãƒ‘ãƒ¼ã‚¹
- ã‚µãƒãƒªãƒ¼ã‚¿ã‚¤ãƒ—: `weekly` | `monthly` | `yearly`ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: `yearly`ï¼‰
- ã‚ªãƒ—ã‚·ãƒ§ãƒ³:
  - `--private`: ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒãƒ£ãƒ³ãƒãƒ«ã‚’å«ã‚ã‚‹
  - æ—¥ä»˜æŒ‡å®š: `2025-01-15` (weekly)
  - æœˆæŒ‡å®š: `1-12` (monthly)

#### Step 4: ã‚»ãƒ«ãƒ•DMãƒãƒ£ãƒ³ãƒãƒ«ã‚ªãƒ¼ãƒ—ãƒ³
- User Tokenã§ `conversations.open` ã‚’å‘¼ã³å‡ºã—ï¼ˆè‡ªåˆ†è‡ªèº«ã¸ã®DMï¼‰
- ã‚»ãƒ«ãƒ•DMã® `channel_id` ã‚’å–å¾—

#### Step 5: é–‹å§‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
- User Tokenã§ã‚»ãƒ«ãƒ•DMã«é–‹å§‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æŠ•ç¨¿
- ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰ `thread_ts` ã‚’å–å¾—

#### Step 6: å³æ™‚ãƒ¬ã‚¹ãƒãƒ³ã‚¹
- Slackã«å³æ™‚ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”å´ï¼ˆ3ç§’ãƒ«ãƒ¼ãƒ«å¯¾å¿œï¼‰
- ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å‡¦ç†ã‚’ `setImmediate` ã§é–‹å§‹

### 3.2 Phase 2: ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å‡¦ç†

#### Step 1: ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ¤œç´¢
- `search.messages` APIï¼ˆUser Tokenå¿…é ˆï¼‰
- ã‚¯ã‚¨ãƒª: `from:<@userId> after:YYYY-MM-DD before:YYYY-MM-DD`
- ã‚¹ãƒ¬ãƒƒãƒ‰è¿”ä¿¡ã‚‚è‡ªå‹•çš„ã«å«ã¾ã‚Œã‚‹

#### Step 2: ãƒãƒ£ãƒ³ãƒãƒ«ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
- ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹è¨­å®šã«åŸºã¥ã„ã¦ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
- `--private` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒãƒ£ãƒ³ãƒãƒ«ã‚‚å«ã‚ã‚‹

#### Step 3: AIè¦ç´„ç”Ÿæˆ
- åé›†ã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’AI APIã«é€ä¿¡
- Vercel AI SDK v5 ã® `generateText` ã‚’ä½¿ç”¨
- ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã¯å¼·å¼±é‡è¦–ã®ã‚µãƒãƒªãƒ¼å½¢å¼

#### Step 4: ã‚µãƒãƒªãƒ¼æŠ•ç¨¿
- User Tokenã§ã‚»ãƒ«ãƒ•DMã‚¹ãƒ¬ãƒƒãƒ‰ã«æŠ•ç¨¿
- ã‚µãƒãƒªãƒ¼ã‚¿ã‚°ã‚’ä»˜ä¸: `[WeeklySummary_2025]`, `[MonthlySummary_2025]`, `[YearlySummary_2025]`
- æœŸé–“ãƒ©ãƒ™ãƒ«: `ğŸ“… æœŸé–“: YYYY/MM/DD ã€œ YYYY/MM/DD`

#### Step 5: å®Œäº†é€šçŸ¥
- å‡¦ç†å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚¹ãƒ¬ãƒƒãƒ‰ã«æŠ•ç¨¿

## 4. OAuthèªå¯ãƒ•ãƒ­ãƒ¼

### 4.1 èªå¯é–‹å§‹
```
GET /oauth/install?user_id={userId}
```
- Slack OAuth URLã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
- User Token Scopesã‚’è¦æ±‚

### 4.2 ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
```
GET /oauth/callback?code={code}&state={state}
```
- Authorization Codeã‚’ãƒˆãƒ¼ã‚¯ãƒ³ã«äº¤æ›
- User Token (`xoxp-...`) ã‚’å–å¾—
- Firestoreã«ä¿å­˜

### 4.3 å¿…è¦ãªUser Token Scopes
| Scope | Purpose |
|-------|---------|
| `search:read` | ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ¤œç´¢ï¼ˆã‚¹ãƒ¬ãƒƒãƒ‰è¿”ä¿¡å«ã‚€ï¼‰ |
| `channels:read` | ãƒ‘ãƒ–ãƒªãƒƒã‚¯ãƒãƒ£ãƒ³ãƒãƒ«ä¸€è¦§ |
| `groups:read` | ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒãƒ£ãƒ³ãƒãƒ«ä¸€è¦§ |
| `users:read` | ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±å–å¾— |
| `chat:write` | ã‚»ãƒ«ãƒ•DMã¸ã®æŠ•ç¨¿ |
| `im:write` | ã‚»ãƒ«ãƒ•DMãƒãƒ£ãƒ³ãƒãƒ«ã®ã‚ªãƒ¼ãƒ—ãƒ³ |
| `im:history` | ã‚»ãƒ«ãƒ•DMã‚¹ãƒ¬ãƒƒãƒ‰ã®èª­ã¿å–ã‚Šï¼ˆæ—¢å­˜ã‚µãƒãƒªãƒ¼å–å¾—ï¼‰ |

## 5. ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆå®šç¾©

| Method | Path | Description |
|--------|------|-------------|
| POST | `/slack/command` | Slackã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã‚³ãƒãƒ³ãƒ‰å—ä¿¡ |
| GET | `/oauth/install` | OAuthèªå¯é–‹å§‹ |
| GET | `/oauth/callback` | OAuthã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ |
| GET | `/health` | ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ |

## 6. ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ‡ãƒ«

### 6.1 User Token (Firestore)

```typescript
// Collection: user_tokens
// Document ID: userId
interface UserTokenDocument {
  accessToken: string;    // User Token (xoxp-...)
  teamId: string;
  userId: string;
  createdAt: Timestamp;
  expiresAt: Timestamp;   // åˆ©ç”¨æ™‚ã«æ›´æ–°ã•ã‚Œã‚‹æœŸé™
}
```

### 6.2 ã‚µãƒãƒªãƒ¼ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£

```typescript
interface Summary {
  id: string;
  type: 'weekly' | 'monthly' | 'yearly';
  content: string;
  dateRange: DateRange;
  year: number;
  weekNumber?: number;
  month?: number;
}
```

### 6.3 ã‚µãƒãƒªãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ

```
[WeeklySummary_2025]
ğŸ“… æœŸé–“: 2025/12/22 ã€œ 2025/12/28

## ä»Šé€±ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ
â˜… é‡è¦ãªæˆæœ1
â˜… é‡è¦ãªæˆæœ2

## æ´»å‹•ã¾ã¨ã‚
- æ´»å‹•å†…å®¹1
- æ´»å‹•å†…å®¹2
```

## 7. ã‚³ãƒãƒ³ãƒ‰ä»•æ§˜

### 7.1 åŸºæœ¬æ§‹æ–‡

```
/summarize-2025 [type] [options] [--flags]
```

### 7.2 ã‚µãƒãƒªãƒ¼ã‚¿ã‚¤ãƒ—

| Type | Description | Example |
|------|-------------|---------|
| (ãªã—) | å¹´æ¬¡ã‚µãƒãƒªãƒ¼ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰ | `/summarize-2025` |
| `weekly` | é€±æ¬¡ã‚µãƒãƒªãƒ¼ | `/summarize-2025 weekly` |
| `monthly` | æœˆæ¬¡ã‚µãƒãƒªãƒ¼ | `/summarize-2025 monthly 12` |
| `yearly` | å¹´æ¬¡ã‚µãƒãƒªãƒ¼ | `/summarize-2025 yearly` |

### 7.3 ã‚ªãƒ—ã‚·ãƒ§ãƒ³

| Option | Description | Default |
|--------|-------------|---------|
| `--private` | ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒãƒ£ãƒ³ãƒãƒ«ã‚’å«ã‚ã‚‹ | `false` |

### 7.4 ã‚³ãƒãƒ³ãƒ‰ä¾‹

```
/summarize-2025                       # å¹´æ¬¡ã‚µãƒãƒªãƒ¼ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
/summarize-2025 yearly                # å¹´æ¬¡ã‚µãƒãƒªãƒ¼
/summarize-2025 yearly --private      # privateãƒãƒ£ãƒ³ãƒãƒ«ã‚‚å«ã‚€
/summarize-2025 monthly 12            # 12æœˆã®ã‚µãƒãƒªãƒ¼
/summarize-2025 monthly 12 --private  # 12æœˆã€privateãƒãƒ£ãƒ³ãƒãƒ«ã‚‚å«ã‚€
/summarize-2025 weekly                # ä»Šé€±ã®ã‚µãƒãƒªãƒ¼
/summarize-2025 weekly 2025-01-15     # 1/15ã‚’å«ã‚€é€±
/summarize-2025 weekly --private      # privateãƒãƒ£ãƒ³ãƒãƒ«ã‚‚å«ã‚€
```

## 8. ç’°å¢ƒå¤‰æ•°

### 8.1 å¿…é ˆ

| Variable | Description |
|----------|-------------|
| `SLACK_BOT_TOKEN` | Slack Bot Token (`xoxb-...`) |
| `SLACK_CLIENT_ID` | Slack App Client ID |
| `SLACK_CLIENT_SECRET` | Slack App Client Secret |
| `SLACK_SIGNING_SECRET` | Slack Signing Secret |
| `OPENAI_API_KEY` | OpenAI API Key (or ANTHROPIC_API_KEY) |
| `GCP_PROJECT_ID` | GCPãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆID |

### 8.2 ã‚ªãƒ—ã‚·ãƒ§ãƒ³

| Variable | Default | Description |
|----------|---------|-------------|
| `AI_MODEL` | `gpt-4o-mini` | ä½¿ç”¨ã™ã‚‹AIãƒ¢ãƒ‡ãƒ« |
| `AI_MAX_TOKENS` | `4096` | æœ€å¤§å‡ºåŠ›ãƒˆãƒ¼ã‚¯ãƒ³æ•° |
| `LOCALE` | `en_US` | å‡ºåŠ›è¨€èª (`en_US` or `ja_JP`) |
| `TARGET_YEAR` | Current year | å¯¾è±¡å¹´ |
| `INCLUDE_CHANNELS` | (empty) | å¯¾è±¡ãƒãƒ£ãƒ³ãƒãƒ«ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰ |
| `EXCLUDE_CHANNELS` | (empty) | é™¤å¤–ãƒãƒ£ãƒ³ãƒãƒ«ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰ |
| `INCLUDE_PRIVATE_CHANNELS` | `false` | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒãƒ£ãƒ³ãƒãƒ«ã‚’å«ã‚ã‚‹ |

## 9. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

### 9.1 ã‚¨ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰

| Code | HTTP Status | Description |
|------|-------------|-------------|
| `INVALID_SIGNATURE` | 401 | Slackç½²åæ¤œè¨¼å¤±æ•— |
| `AUTHORIZATION_REQUIRED` | 200 | User Tokenæœªå–å¾—ï¼ˆOAuthèªå¯ãŒå¿…è¦ï¼‰ |
| `INVALID_COMMAND` | 400 | ã‚³ãƒãƒ³ãƒ‰æ§‹æ–‡ã‚¨ãƒ©ãƒ¼ |
| `NO_POSTS_FOUND` | 200 | å¯¾è±¡æœŸé–“ã«æŠ•ç¨¿ãªã— |
| `AI_ERROR` | 500 | AI APIå‘¼ã³å‡ºã—ã‚¨ãƒ©ãƒ¼ |
| `SLACK_API_ERROR` | 500 | Slack APIå‘¼ã³å‡ºã—ã‚¨ãƒ©ãƒ¼ |

## 10. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

### 10.1 èªè¨¼ãƒ»èªå¯

- **Slackãƒªã‚¯ã‚¨ã‚¹ãƒˆæ¤œè¨¼**: ç½²åãƒ™ãƒ¼ã‚¹ (HMAC-SHA256)
- **User Token OAuth**: ãƒ¦ãƒ¼ã‚¶ãƒ¼è‡ªèº«ã®æ¨©é™ã§ã®ã¿ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—
- **ã‚»ãƒ«ãƒ•DMæŠ•ç¨¿**: ãƒ¦ãƒ¼ã‚¶ãƒ¼è‡ªèº«ã®DMã«ã®ã¿æŠ•ç¨¿ï¼ˆä»–ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã¯è¦‹ãˆãªã„ï¼‰

### 10.2 ãƒ‡ãƒ¼ã‚¿ä¿è­·

- **User Token**: Firestoreã«æš—å·åŒ–ã—ã¦ä¿å­˜
- **ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ‡ãƒ¼ã‚¿**: ä¸€æ™‚çš„ã«ãƒ¡ãƒ¢ãƒªã«ä¿æŒã€æ°¸ç¶šåŒ–ã—ãªã„
- **ã‚µãƒãƒªãƒ¼**: ã‚»ãƒ«ãƒ•DMã«æŠ•ç¨¿ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼è‡ªèº«ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ï¼‰

## 11. ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆ

### 11.1 Cloud Runè¨­å®š

| Setting | Value |
|---------|-------|
| CPU | 1 |
| Memory | 512Mi |
| Min instances | 0 |
| Max instances | 10 |
| Timeout | 300s |
| Concurrency | 80 |

### 11.2 Firestoreè¨­å®š

| Collection | Document ID | Description |
|------------|-------------|-------------|
| `user_tokens` | `{userId}` | User Tokenã‚’ä¿å­˜ |

---

## 12. å¤‰æ›´å±¥æ­´

| Version | Date | Changes |
|---------|------|---------|
| v1 | - | åˆæœŸä»•æ§˜ (Cloudflare Workers) |
| v2 | - | AI SDK v6å¯¾å¿œã€Zod v4å¯¾å¿œ |
| v3 | - | Cloud Run + Pub/Sub ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã¸ç§»è¡Œ |
| v4 | 2025-12-30 | User Token OAuthã€ã‚»ãƒ«ãƒ•DMæŠ•ç¨¿ã€åŒæœŸãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰å‡¦ç†ã¸å¤‰æ›´ã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚³ãƒãƒ³ãƒ‰ã‚’yearlyã«å¤‰æ›´ã€‚ |
